<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Expense Tracker by Harshit Dani</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      color: #333;
      margin: 0;
      padding: 40px 15px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container {
      background: #fff;
      max-width: 900px;
      width: 100%;
      padding: 30px 30px 40px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    h1 {
      font-weight: 700;
      color: #222;
      margin: 0;
      user-select: none;
      text-align: center;
      font-size: 2rem;
    }

    h2 {
      font-weight: 700;
      color: #222;
      margin: 0 0 10px;
      user-select: none;
      border-bottom: 2px solid #007bff;
      padding-bottom: 6px;
    }

    form {
      display: flex;
      flex-wrap: wrap;
      gap: 15px 20px;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 10px;
    }

    form > div {
      flex: 1 1 180px;
      min-width: 140px;
    }

    label {
      font-weight: 600;
      margin-bottom: 6px;
      color: #444;
      user-select: none;
      display: block;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1.8px solid #bbb;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus,
    select:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 5px #007bffaa;
    }

    .button-group {
      display: flex;
      gap: 20px;
      flex: 1 1 100%;
      justify-content: flex-start;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 26px;
      border: none;
      border-radius: 7px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: background-color 0.25s ease;
      color: white;
      user-select: none;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.15);
      min-width: 140px;
      text-align: center;
      flex: none;
    }

    button[type="submit"] {
      background-color: #007bff;
    }
    button[type="submit"]:hover {
      background-color: #0056b3;
    }

    button[type="button"] {
      background-color: #007bff;
    }
    button[type="button"]:hover {
      background-color: #0056b3;
    }

    /* Totals display below buttons */
    .totals {
      display: flex;
      gap: 20px;
      justify-content: flex-start;
      flex-wrap: wrap;
      margin-top: 10px;
      user-select: none;
      font-weight: 700;
      font-size: 1rem;
      color: #222;
    }

    .totals div {
      background: #e9f0ff;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgb(0 123 255 / 0.25);
      min-width: 130px;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px;
      margin-top: 10px;
    }

    thead th {
      text-align: left;
      padding: 12px 15px;
      background-color: #007bff;
      color: white;
      border-radius: 8px 8px 0 0;
      user-select: none;
    }

    tbody tr {
      background: white;
      box-shadow: 0 2px 5px rgb(0 0 0 / 0.07);
      border-radius: 8px;
      transition: background-color 0.2s;
    }

    tbody tr:hover {
      background-color: #f1f7ff;
    }

    tbody td {
      padding: 12px 15px;
      vertical-align: middle;
      color: #333;
    }

    tbody td:last-child {
      width: 110px;
      text-align: center;
    }

    /* Smaller, inline Edit/Delete buttons */
    .action-btns {
      display: flex;
      gap: 6px;
      justify-content: center;
      align-items: center;
    }

    .action-btns button {
      padding: 5px 10px;
      font-size: 0.85rem;
      font-weight: 600;
      border-radius: 5px;
      box-shadow: none;
      min-width: auto;
      flex: none;
      line-height: 1.2;
    }

    .action-btns button:first-child {
      background-color: #28a745;
      color: white;
      border: none;
    }

    .action-btns button:last-child {
      background-color: #dc3545;
      color: white;
      border: none;
    }

    /* Chart container side by side */
    .charts-container {
      display: flex;
      gap: 30px;
      margin-top: 40px;
      flex-wrap: nowrap;
      justify-content: center;
    }

    canvas {
      flex: 1 1 45%;
      max-width: 45%;
      max-height: 280px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgb(0 0 0 / 0.1);
    }

    /* Responsive */
    @media (max-width: 480px) {
  .totals div {
    flex: 1 1 100%;
    min-width: auto;
  }

  table {
    display: block;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  thead, tbody, tr, th, td {
    white-space: nowrap;
  }

  .action-btns {
    flex-direction: column;
    gap: 4px;
  }

  .action-btns button {
    width: 100%;
    padding: 6px 8px;
  }
}
  </style>
</head>
<body>

  <div class="container">
    <h1>Expense Tracker by Harshit Dani</h1>

    <div style="text-align:center; margin-bottom: 20px;">
  <button id="connectFileBtn" type="button" style="display:none; background:#17a2b8; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:600; box-shadow: 0 3px 6px rgb(0 123 255 / 0.25); user-select:none;">
    Connect File for Auto Save
  </button>
</div>

    <form id="expense-form" autocomplete="off" novalidate>
      <div>
        <label for="date">Date</label>
        <input type="date" id="date" required />
      </div>

      <div>
        <label for="category">Category</label>
        <select id="category" required>
          <option value="">Select</option>
          <option>Food</option>
          <option>Transport</option>
          <option>Entertainment</option>
          <option>Utilities</option>
          <option>Others</option>
        </select>
      </div>

      <div>
        <label for="description">Description</label>
        <input type="text" id="description" placeholder="e.g. Grocery shopping" required />
      </div>

      <div>
        <label for="amount">Amount (₹)</label>
        <input type="number" id="amount" min="0" step="0.01" placeholder="0.00" required />
      </div>

      <div class="button-group">
        <button type="submit">Add Expense</button>
        <button id="upload-csv-btn" type="button">Upload CSV</button>
        <input type="file" id="upload-csv" accept=".csv" style="display: none;" />
        <button type="button" onclick="downloadCSV()">Download CSV</button>
      </div>
    </form>

    <div class="totals" aria-live="polite" aria-atomic="true" aria-relevant="text">
      <div>Daily Total: ₹<span id="daily-total">0.00</span></div>
      <div>Weekly Total: ₹<span id="weekly-total">0.00</span></div>
      <div>Monthly Total: ₹<span id="monthly-total">0.00</span></div>
    </div>

    <h2>Expenses</h2>
    <table aria-label="Expense entries">
      <thead>
        <tr>
          <th>Date</th>
          <th>Category</th>
          <th>Description</th>
          <th>Amount (₹)</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="expense-list">
        <!-- Filled dynamically -->
      </tbody>
    </table>

    <h2>Summary Charts</h2>
    <div class="charts-container">
      <canvas id="categoryChart" aria-label="Expenses by category" role="img"></canvas>
      <canvas id="monthChart" aria-label="Monthly expenses for current year" role="img"></canvas>
    </div>
  </div>

  <script>
    (() => {
      "use strict";

      // File System Access API CSV appender logic
const connectFileBtn = document.getElementById('connectFileBtn');
let csvFileHandle = null;

// Trigger file input dialog when button is clicked
document.getElementById('upload-csv-btn').addEventListener('click', () => {
  document.getElementById('upload-csv').click();
});

// Handle file selection
document.getElementById('upload-csv').addEventListener('change', async (event) => {
  const file = event.target.files[0];
  if (!file) {
    alert('Please select a file.');
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    const content = e.target.result;
    parseCSV(content);
  };
  reader.onerror = () => {
    alert('Error reading the file.');
  };
  reader.readAsText(file);
});



// Parse CSV Content
function parseCSV(content) {
  const rows = content.split(/\r?\n/).filter(row => row.trim() !== ''); // Handle both LF and CRLF line endings
  if (rows.length < 2) {
    alert('Invalid CSV format: No data rows found.');
    return;
  }

  const header = rows.shift().split(',').map(h => h.trim());

  // Validate Header
  const expectedHeader = ['Date', 'Category', 'Description', 'Amount (₹)'];
  if (!header.every((col, index) => col === expectedHeader[index])) {
    alert(`Invalid CSV format: Expected header: ${expectedHeader.join(', ')}`);
    return;
  }

  rows.forEach((row, index) => {
    const columns = row.split(',').map(col => col.replace(/(^"|"$)/g, '').trim());

    if (columns.length !== 4) {
      console.warn(`Skipping invalid row ${index + 2}: ${row}`); // Row index adjusted for 1-based CSV indexing
      return;
    }

    const [date, category, description, amount] = columns;

    // Validate data
    if (!date || !category || !description || isNaN(parseFloat(amount))) {
      console.warn(`Skipping invalid data in row ${index + 2}: ${row}`);
      return;
    }

    // Add to expenses
    expenses.push({
      date,
      category,
      description,
      amount: parseFloat(amount).toFixed(2),
    });
  });

  // Save and Refresh UI
  saveExpenses();
  renderExpenses();
  updateTotals();
  updateCharts();
  alert('CSV data uploaded successfully!');
}


// IndexedDB wrapper to save file handle using structured clone
function getDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open('expense-tracker-db', 1);
    req.onupgradeneeded = e => {
      e.target.result.createObjectStore('handles');
    };
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = e => reject(e.target.error);
  });
}

async function saveFileHandle(handle) {
  const db = await getDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction('handles', 'readwrite');
    const store = tx.objectStore('handles');
    store.put(handle, 'csvFile');
    tx.oncomplete = () => resolve();
    tx.onerror = e => reject(e.target.error);
  });
}

async function loadFileHandle() {
  const db = await getDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction('handles', 'readonly');
    const store = tx.objectStore('handles');
    const req = store.get('csvFile');
    req.onsuccess = e => resolve(e.target.result);
    req.onerror = e => reject(e.target.error);
  });
}

async function verifyPermission(fileHandle, withWrite) {
  const opts = {};
  if (withWrite) opts.mode = 'readwrite';
  if ((await fileHandle.queryPermission(opts)) === 'granted') return true;
  if ((await fileHandle.requestPermission(opts)) === 'granted') return true;
  return false;
}

async function appendExpenseToFile(expense) {
  if (!csvFileHandle) return;

  try {
    if (!(await verifyPermission(csvFileHandle, true))) {
      alert('No permission to write to the connected CSV file.');
      return;
    }

    // Get existing contents to append properly
    const file = await csvFileHandle.getFile();
    const text = await file.text();

    // Prepare CSV line for new expense
    // Escape quotes & commas properly:
    function escapeCSVField(str) {
      if (typeof str !== 'string') str = str.toString();
      if (str.includes('"') || str.includes(',') || str.includes('\n')) {
        return `"${str.replace(/"/g, '""')}"`;
      }
      return str;
    }

    const line = [
      escapeCSVField(expense.date),
      escapeCSVField(expense.category),
      escapeCSVField(expense.description),
      escapeCSVField(expense.amount)
    ].join(',') + '\n';

    // Append the new line to existing CSV content
    const writable = await csvFileHandle.createWritable();
    // Write original content + new line
    await writable.write(text + line);
    await writable.close();

  } catch (err) {
    alert('Error writing to file: ' + err.message);
  }
}

// Show the Connect File button only if API is supported and no file connected yet
async function checkAndSetupFileConnection() {
  if (!window.showSaveFilePicker) {
    // API not supported, hide button
    connectFileBtn.style.display = 'none';
    return;
  }

  try {
    csvFileHandle = await loadFileHandle();
    if (csvFileHandle) {
      // We have saved file handle, check permission
      if (!(await verifyPermission(csvFileHandle, true))) {
        connectFileBtn.style.display = 'inline-block';
      } else {
        connectFileBtn.style.display = 'none';
      }
    } else {
      connectFileBtn.style.display = 'inline-block';
    }
  } catch {
    connectFileBtn.style.display = 'inline-block';
  }
}

// On clicking Connect File
connectFileBtn.onclick = async () => {
  try {
    const opts = {
      types: [{
        description: 'CSV file',
        accept: { 'text/csv': ['.csv'] },
      }],
      suggestedName: 'expenses.csv',
      excludeAcceptAllOption: true,
      multiple: false,
    };

    const handle = await window.showSaveFilePicker(opts);
    if (handle) {
      csvFileHandle = handle;
      await saveFileHandle(handle);

      // Check if file is empty and write header + data
      const file = await csvFileHandle.getFile();
      const writable = await csvFileHandle.createWritable();

      const csvHeader = 'Date,Category,Description,Amount (₹)\n';
      const csvRows = expenses.map(exp => {
        return [
          `"${exp.date}"`,
          `"${exp.category}"`,
          `"${exp.description.replace(/"/g, '""')}"`, // Escape double quotes
          `"${exp.amount}"`,
        ].join(',');
      }).join('\n');

      // Write header if file is empty
      if (file.size === 0) {
        await writable.write(csvHeader + csvRows);
      } else {
        await writable.write(csvRows); // Append rows to existing content
      }

      await writable.close();

      connectFileBtn.style.display = 'none';
      alert('File connected and existing data saved successfully!');
    }
  } catch (e) {
    if (e.name !== 'AbortError') {
      alert('Error connecting file: ' + e.message);
    }
  }
};


// Call on init to setup button visibility
checkAndSetupFileConnection();


      // Elements
      const form = document.getElementById('expense-form');
      const dateInput = document.getElementById('date');
      const categoryInput = document.getElementById('category');
      const descInput = document.getElementById('description');
      const amountInput = document.getElementById('amount');
      const expenseListTbody = document.getElementById('expense-list');
      const dailyTotalSpan = document.getElementById('daily-total');
      const weeklyTotalSpan = document.getElementById('weekly-total');
      const monthlyTotalSpan = document.getElementById('monthly-total');

      // Chart contexts
      const categoryCtx = document.getElementById('categoryChart').getContext('2d');
      const monthCtx = document.getElementById('monthChart').getContext('2d');

      // Constants
      const CATEGORY_OPTIONS = ["Food", "Transport", "Entertainment", "Utilities", "Others"];

      // Data
      let expenses = [];
      let editIndex = -1;

      // Chart instances
      let categoryChart = null;
      let monthChart = null;

      // Initialize date input default to today
      function setTodayDate() {
        const today = new Date().toISOString().slice(0, 10);
        dateInput.value = today;
      }

      // Load expenses from localStorage
      function loadExpenses() {
        const stored = localStorage.getItem('expenses');
        if (stored) {
          try {
            expenses = JSON.parse(stored);
            if (!Array.isArray(expenses)) expenses = [];
          } catch {
            expenses = [];
          }
        }
      }

      // Save expenses to localStorage
      function saveExpenses() {
        localStorage.setItem('expenses', JSON.stringify(expenses));
      }

      // Render the expense list in the table
      function renderExpenses() {
        expenseListTbody.innerHTML = '';
        expenses.forEach((exp, i) => {
          const tr = document.createElement('tr');

          const tdDate = document.createElement('td');
          tdDate.textContent = exp.date;
          tr.appendChild(tdDate);

          const tdCategory = document.createElement('td');
          tdCategory.textContent = exp.category;
          tr.appendChild(tdCategory);

          const tdDesc = document.createElement('td');
          tdDesc.textContent = exp.description;
          tr.appendChild(tdDesc);

          const tdAmount = document.createElement('td');
          tdAmount.textContent = Number(exp.amount).toFixed(2);
          tr.appendChild(tdAmount);

          const tdActions = document.createElement('td');
          const actionDiv = document.createElement('div');
          actionDiv.className = 'action-btns';

          // Edit button
          const btnEdit = document.createElement('button');
          btnEdit.textContent = 'Edit';
          btnEdit.title = 'Edit this expense';
          btnEdit.onclick = () => startEditExpense(i);
          actionDiv.appendChild(btnEdit);

          // Delete button
          const btnDelete = document.createElement('button');
          btnDelete.textContent = 'Delete';
          btnDelete.title = 'Delete this expense';
          btnDelete.onclick = () => deleteExpense(i);
          actionDiv.appendChild(btnDelete);

          tdActions.appendChild(actionDiv);
          tr.appendChild(tdActions);

          expenseListTbody.appendChild(tr);
        });
      }

      // Update totals
      function updateTotals() {
        const now = new Date();
        const todayStr = now.toISOString().slice(0, 10);

        // Helper to get start of week (Monday)
        function getMonday(d) {
          const date = new Date(d);
          const day = date.getDay();
          const diff = (day === 0 ? -6 : 1) - day; // Monday is 1
          return new Date(date.getFullYear(), date.getMonth(), date.getDate() + diff);
        }
        const monday = getMonday(now);

        // Start of month
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

        let dailyTotal = 0;
        let weeklyTotal = 0;
        let monthlyTotal = 0;

        expenses.forEach(({date, amount}) => {
          if (!date || isNaN(amount)) return;
          const d = new Date(date);
          const amt = Number(amount);
          if (date === todayStr) dailyTotal += amt;
          if (d >= monday && d <= now) weeklyTotal += amt;
          if (d >= startOfMonth && d <= now) monthlyTotal += amt;
        });

        dailyTotalSpan.textContent = dailyTotal.toFixed(2);
        weeklyTotalSpan.textContent = weeklyTotal.toFixed(2);
        monthlyTotalSpan.textContent = monthlyTotal.toFixed(2);
      }

      // Update charts
      function updateCharts() {
        // Category chart data (for all time)
        const catTotals = {};
        CATEGORY_OPTIONS.forEach(c => catTotals[c] = 0);
        expenses.forEach(({category, amount}) => {
          if (catTotals.hasOwnProperty(category)) {
            catTotals[category] += Number(amount);
          }
        });
        const catLabels = Object.keys(catTotals);
        const catData = Object.values(catTotals);

        if (categoryChart) categoryChart.destroy();
        categoryChart = new Chart(categoryCtx, {
          type: 'doughnut',
          data: {
            labels: catLabels,
            datasets: [{
              label: 'Expenses by Category',
              data: catData,
              backgroundColor: [
                '#007bff', '#28a745', '#ffc107', '#17a2b8', '#6c757d'
              ],
              borderColor: '#fff',
              borderWidth: 2,
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {position: 'bottom'},
              tooltip: {mode: 'index', intersect: false}
            }
          }
        });

        // Monthly chart for current year
        const now = new Date();
        const year = now.getFullYear();
        const monthTotals = Array(12).fill(0);
        expenses.forEach(({date, amount}) => {
          if (!date) return;
          const d = new Date(date);
          if (d.getFullYear() === year) {
            monthTotals[d.getMonth()] += Number(amount);
          }
        });

        if (monthChart) monthChart.destroy();
        monthChart = new Chart(monthCtx, {
          type: 'bar',
          data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            datasets: [{
              label: `Monthly Expenses ${year}`,
              data: monthTotals,
              backgroundColor: '#007bffaa',
              borderColor: '#0056b3',
              borderWidth: 1,
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 500
                }
              }
            },
            plugins: {
              legend: {display: true, position: 'bottom'},
              tooltip: {mode: 'index', intersect: false}
            }
          }
        });
      }

      // Add or update expense
      function addOrUpdateExpense(event) {
        event.preventDefault();

        // Validate inputs
        if (!dateInput.value) {
          alert('Please select a date.');
          return;
        }
        if (!categoryInput.value) {
          alert('Please select a category.');
          return;
        }
        if (!descInput.value.trim()) {
          alert('Please enter a description.');
          return;
        }
        if (!amountInput.value || Number(amountInput.value) <= 0) {
          alert('Please enter a valid amount.');
          return;
        }

        const newExp = {
          date: dateInput.value,
          category: categoryInput.value,
          description: descInput.value.trim(),
          amount: Number(amountInput.value).toFixed(2)
        };

        if (editIndex === -1) {
          expenses.push(newExp);
        } else {
          expenses[editIndex] = newExp;
          editIndex = -1;
          form.querySelector('button[type=submit]').textContent = 'Add Expense';
        }

        saveExpenses();
        renderExpenses();
        updateTotals();
        updateCharts();

        form.reset();
        setTodayDate();
        appendExpenseToFile(newExp);
      }

      // Start editing an expense
      function startEditExpense(i) {
        const exp = expenses[i];
        dateInput.value = exp.date;
        categoryInput.value = exp.category;
        descInput.value = exp.description;
        amountInput.value = exp.amount;
        editIndex = i;
        form.querySelector('button[type=submit]').textContent = 'Update Expense';
        descInput.focus();
      }

      // Delete an expense
      function deleteExpense(i) {
        if (confirm('Are you sure you want to delete this expense?')) {
          expenses.splice(i, 1);
          saveExpenses();
          renderExpenses();
          updateTotals();
          updateCharts();
          if (editIndex === i) {
            editIndex = -1;
            form.querySelector('button[type=submit]').textContent = 'Add Expense';
            form.reset();
            setTodayDate();
          }
        }
      }

      // Download CSV export of expenses
      window.downloadCSV = function() {
        if (expenses.length === 0) {
          alert('No expenses to export.');
          return;
        }
        const header = ['Date', 'Category', 'Description', 'Amount (₹)'];
        const rows = expenses.map(e => [e.date, e.category, e.description, e.amount]);
        const csvContent = [header, ...rows]
          .map(row => row.map(field => `"${field.toString().replace(/"/g, '""')}"`).join(','))
          .join('\n');

        const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `expenses_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      // Initialization
      function init() {
        setTodayDate();
        loadExpenses();
        renderExpenses();
        updateTotals();
        updateCharts();

        form.addEventListener('submit', addOrUpdateExpense);
      }

      init();
    })();
  </script>
</body>
</html>
